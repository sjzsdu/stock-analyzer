"""
å¢å¼ºç‰ˆåˆ†æPromptæ¨¡æ¿
æ·»åŠ è¯¦ç»†åˆ†æã€ç½®ä¿¡åº¦è¯„ä¼°å’Œè¯æ®å¼•ç”¨
"""

from typing import Dict, Any, List
from datetime import datetime


# è¯¦ç»†åˆ†æè¾“å‡ºæ¨¡æ¿
DETAILED_ANALYSIS_PROMPT = """
# è‚¡ç¥¨è¯¦ç»†åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦
[ç”¨2-3å¥è¯æ€»ç»“è¯¥è‚¡ç¥¨çš„æ•´ä½“åˆ†æç»“è®ºï¼ŒåŒ…æ‹¬æ ¸å¿ƒæŠ•èµ„è§‚ç‚¹å’Œä¸»è¦é£é™©]

## å…³é”®å‘ç°
- **[æŒ‡æ ‡1]**: [å…·ä½“æ•°å€¼] vs [åŸºå‡†/è¡Œä¸šå¹³å‡] ([å·®å¼‚/çœ‹æ³•])
- **[æŒ‡æ ‡2]**: [è¶‹åŠ¿æè¿°] ([æ—¶é—´å‘¨æœŸ])
- **[æŒ‡æ ‡3]**: [å¯¹æ¯”ç»“æœ] ([æ’å/ä½ç½®])

## è¯¦ç»†åˆ†æ

### 1. æ•°æ®è§‚å¯Ÿ
è¯·åˆ—å‡ºåˆ†æè¿‡ç¨‹ä¸­ä½¿ç”¨çš„ä¸»è¦æ•°æ®ç‚¹ï¼š
- è´¢åŠ¡æŒ‡æ ‡: [å…·ä½“æ•°å€¼å’Œæ¥æº]
- æŠ€æœ¯æŒ‡æ ‡: [å…·ä½“æ•°å€¼å’Œä¿¡å·]
- è¡Œä¸šå¯¹æ¯”: [ç›¸å¯¹ä½ç½®]

### 2. æ¨ç†è¿‡ç¨‹
è¯·è¯¦ç»†è¯´æ˜åˆ†æé€»è¾‘ï¼š
1. é¦–å…ˆè§‚å¯Ÿåˆ°[æ•°æ®A]ï¼Œè¡¨æ˜[ç°è±¡]
2. ç»“åˆ[æ•°æ®B]ï¼Œè¿›ä¸€æ­¥éªŒè¯[ç»“è®º]
3. è€ƒè™‘[æ•°æ®C]çš„å½±å“ï¼Œæœ€ç»ˆå¾—å‡º[ç»“è®º]

### 3. æ”¯æ’‘è¯æ®
è¯·æä¾›å…·ä½“çš„åˆ†æä¾æ®ï¼š
| æŒ‡æ ‡ | æ•°å€¼ | å‚è€ƒåŸºå‡† | åˆ¤æ–­ä¾æ® |
|------|------|----------|----------|
| [PE] | [xx] | è¡Œä¸šå‡å€¼[xx] | [é«˜/ä½/åˆç†] |
| [ROE] | [xx] | 5å¹´å‡å€¼[xx] | [è¶‹åŠ¿æè¿°] |
| [è¥æ”¶å¢é•¿] | [xx] | è¡Œä¸šä¸­ä½æ•°[xx] | [ç«äº‰åŠ›è¯„ä»·] |

## ç½®ä¿¡åº¦è¯„ä¼°

**ç»¼åˆç½®ä¿¡åº¦**: [0-100]%

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| æ•°æ®å®Œæ•´æ€§ | [0-100] | [å®Œæ•´/éƒ¨åˆ†/æœ‰é™] |
| æŒ‡æ ‡ä¸€è‡´æ€§ | [0-100] | [ä¸€è‡´/æœ‰åˆ†æ­§/çŸ›ç›¾] |
| è¡Œä¸šç¨³å®šæ€§ | [0-100] | [ç¨³å®š/æ³¢åŠ¨/ä¸ç¡®å®š] |
| é¢„æµ‹å¯é æ€§ | [0-100] | [é«˜/ä¸­/ä½] |

**ä¸»è¦é™åˆ¶**:
- [åˆ—å‡ºåˆ†æä¸­çš„ä¸ç¡®å®šæ€§å› ç´ ]
- [åˆ—å‡ºæ•°æ®ç¼ºå¤±æˆ–æ»åçš„å½±å“]

## é£é™©å› ç´ 

| é£é™© | æ¦‚ç‡ | å½±å“ | åº”å¯¹å»ºè®® |
|------|------|------|----------|
| [é£é™©1] | é«˜/ä¸­/ä½ | å¤§/ä¸­/å° | [å»ºè®®] |
| [é£é™©2] | é«˜/ä¸­/ä½ | å¤§/ä¸­/å° | [å»ºè®®] |

## æŠ•èµ„å»ºè®®

**ç»¼åˆè¯„åˆ†**: [0-100]åˆ†

**æ“ä½œå»ºè®®**: [å¼ºçƒˆä¹°å…¥/ä¹°å…¥/æŒæœ‰/è§‚æœ›/å–å‡º/å¼ºçƒˆå–å‡º]

**ç†ç”±æ€»ç»“**:
[ç”¨1-2å¥è¯æ€»ç»“æ¨èç†ç”±]

**å…³é”®å…³æ³¨ç‚¹**:
- [æŠ•èµ„è€…éœ€è¦å…³æ³¨çš„1-2ä¸ªå…³é”®æŒ‡æ ‡æˆ–äº‹ä»¶]
"""

# å„Agentä¸“ç”¨Promptæ¨¡æ¿

VALUE_AGENT_PROMPT = """
ä½ æ˜¯èµ„æ·±ä»·å€¼æŠ•èµ„åˆ†æå¸ˆï¼Œæ‹¥æœ‰20å¹´å·´è²ç‰¹å¼ä»·å€¼æŠ•èµ„ç»éªŒã€‚

**åˆ†æä»»åŠ¡**: åˆ†æ{stock_name}({symbol})çš„ä¼°å€¼æ°´å¹³

**åˆ†æè¦æ±‚**:
1. ä½¿ç”¨ç»å¯¹ä¼°å€¼ï¼ˆDCFã€NAVï¼‰å’Œç›¸å¯¹ä¼°å€¼ï¼ˆP/Eã€P/Bã€EV/EBITDAï¼‰æ–¹æ³•
2. æä¾›å…·ä½“çš„æ•°å€¼è®¡ç®—å’Œå¯¹æ¯”åŸºå‡†
3. æ ‡æ³¨æ•°æ®æ¥æºå’Œæ—¶é—´èŒƒå›´
4. ç»™å‡ºç½®ä¿¡åº¦è¯„åˆ†

**è¾“å‡ºæ ¼å¼**:
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

```
## ä¼°å€¼åˆ†æ

### 1. ç»å¯¹ä¼°å€¼
- DCFä¼°å€¼: [é‡‘é¢]å…ƒ/è‚¡
- è®¡ç®—ä¾æ®: [FCFé¢„æµ‹ã€ç»ˆå€¼ã€æŠ˜ç°ç‡ç­‰å…³é”®å‡è®¾]
- éšå«å›æŠ¥ç‡: [ç›¸å¯¹å½“å‰ä»·æ ¼çš„é¢„æœŸå›æŠ¥]

### 2. ç›¸å¯¹ä¼°å€¼
- å½“å‰P/E: [æ•°å€¼] vs è¡Œä¸šå‡å€¼[æ•°å€¼] ([æº¢ä»·/æŠ˜ä»·]%)
- å½“å‰P/B: [æ•°å€¼] vs 5å¹´å‡å€¼[æ•°å€¼] ([å†å²ä½ç½®])
- EV/EBITDA: [æ•°å€¼] vs è¡Œä¸šä¸­ä½æ•°[æ•°å€¼]

### 3. ä¼°å€¼ç»“è®º
[é«˜ä¼°/åˆç†/ä½ä¼°]çš„åŸå› ï¼š
1. [å…·ä½“ç†ç”±1]
2. [å…·ä½“ç†ç”±2]

### 4. ç½®ä¿¡åº¦è¯„ä¼°
æ•°æ®å®Œæ•´æ€§: [0-100]åˆ† (åŸºäºå¯è·å¾—çš„è´¢åŠ¡æ•°æ®)
æŒ‡æ ‡ä¸€è‡´æ€§: [0-100]åˆ† (å„ä¼°å€¼æ–¹æ³•ç»“è®ºä¸€è‡´ç¨‹åº¦)
è¡Œä¸šå¯æ¯”æ€§: [0-100]åˆ† (è¡Œä¸šç¨³å®šæ€§)

ç»¼åˆç½®ä¿¡åº¦: [0-100]åˆ†

### 5. ä¸»è¦é™åˆ¶
- [åˆ—å‡º1-2ä¸ªä¸»è¦ä¸ç¡®å®šæ€§]

### 6. é£é™©å› ç´ 
- ä¼°å€¼å‡è®¾è¿‡äºä¹è§‚: ä¸­æ¦‚ç‡, ä¸­å½±å“
- è¡Œä¸šä¼°å€¼ä¸­æ¢ä¸‹ç§»: ä¸­æ¦‚ç‡, å¤§å½±å“
```

**é‡è¦**: æ‰€æœ‰æ•°å€¼å¿…é¡»åŸºäºæä¾›çš„çœŸå®æ•°æ®ï¼Œä¸è¦ç¼–é€ ã€‚
"""

TECHNICAL_AGENT_PROMPT = """
ä½ æ˜¯èµ„æ·±æŠ€æœ¯åˆ†æå¸ˆï¼Œæ‹¥æœ‰20å¹´æŠ€æœ¯åˆ†æç»éªŒã€‚

**åˆ†æä»»åŠ¡**: åˆ†æ{stock_name}({symbol})çš„æŠ€æœ¯å½¢æ€

**åˆ†æè¦æ±‚**:
1. åˆ†æè¶‹åŠ¿ã€æ”¯æ’‘é˜»åŠ›ã€å½¢æ€ã€æŒ‡æ ‡ä¿¡å·
2. æä¾›å…·ä½“çš„ä»·ä½å’ŒæŒ‡æ ‡æ•°å€¼
3. æ ‡æ³¨æ—¶é—´å‘¨æœŸå’Œä¿¡å·å¼ºåº¦
4. ç»™å‡ºç½®ä¿¡åº¦è¯„åˆ†

**è¾“å‡ºæ ¼å¼**:
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

```
## æŠ€æœ¯åˆ†æ

### 1. è¶‹åŠ¿åˆ¤æ–­
- é•¿æœŸ(200æ—¥): [ä¸Šå‡/ä¸‹é™/éœ‡è¡] - ä»·æ ¼[é«˜äº/ä½äº]200æ—¥å‡çº¿[xx%]
- ä¸­æœŸ(50æ—¥): [ä¸Šå‡/ä¸‹é™/éœ‡è¡] - ä»·æ ¼[é«˜äº/ä½äº]50æ—¥å‡çº¿[xx%]
- çŸ­æœŸ(5æ—¥): [ä¸Šå‡/ä¸‹é™/éœ‡è¡] - ä»·æ ¼[é«˜äº/ä½äº]5æ—¥å‡çº¿[xx%]

### 2. å…³é”®ä»·ä½
- æ”¯æ’‘ä½1: [ä»·æ ¼]å…ƒ ([æ”¯æ’‘ç†ç”±])
- æ”¯æ’‘ä½2: [ä»·æ ¼]å…ƒ ([æ”¯æ’‘ç†ç”±])
- é˜»åŠ›ä½1: [ä»·æ ¼]å…ƒ ([é˜»åŠ›ç†ç”±])
- é˜»åŠ›ä½2: [ä»·æ ¼]å…ƒ ([é˜»åŠ›ç†ç”±])

### 3. æŠ€æœ¯æŒ‡æ ‡
| æŒ‡æ ‡ | æ•°å€¼ | ä¿¡å· | å¼ºåº¦ |
|------|------|------|------|
| RSI(14) | [æ•°å€¼] | [è¶…ä¹°/è¶…å–/ä¸­æ€§] | å¼º/ä¸­/å¼± |
| MACD | [æ•°å€¼] | [é‡‘å‰/æ­»å‰/ä¸­æ€§] | å¼º/ä¸­/å¼± |
| å¸ƒæ—å¸¦ | [ä½ç½®] | [ä¸Šè½¨/ä¸­è½¨/ä¸‹è½¨] | å¼º/ä¸­/å¼± |

### 4. å½¢æ€åˆ†æ
å½“å‰å½¢æ€: [æè¿°å…·ä½“å½¢æ€å¦‚å¤´è‚©é¡¶ã€ä¸‰è§’å½¢æ•´ç†ç­‰]
çªç ´ä¿¡å·: [æ˜¯/å¦] - [å…·ä½“æè¿°]
é‡ä»·é…åˆ: [å¥åº·/èƒŒç¦»/ä¸€èˆ¬]

### 5. æŠ€æœ¯é¢ç»“è®º
ç»¼åˆè¯„åˆ†: [0-100]åˆ†

æŠ€æœ¯é¢ç»¼åˆè¯„ä»·:
[è¯¦ç»†è¯´æ˜æŠ€æœ¯é¢çš„åˆ©å¼Šå› ç´ ]

### 6. ç½®ä¿¡åº¦è¯„ä¼°
è¶‹åŠ¿æ˜ç¡®æ€§: [0-100]åˆ†
ä¿¡å·å¯é æ€§: [0-100]åˆ† (åŸºäºå†å²éªŒè¯)
é‡ä»·é…åˆåº¦: [0-100]åˆ†

ç»¼åˆç½®ä¿¡åº¦: [0-100]åˆ†

### 7. ä¸»è¦é™åˆ¶
- [åˆ—å‡º1-2ä¸ªæŠ€æœ¯åˆ†æçš„ä¸ç¡®å®šæ€§]

### 8. é£é™©æç¤º
- å‡çªç ´é£é™©: ä¸­æ¦‚ç‡, ä¸­å½±å“
- æŠ€æœ¯å¤±çœŸ: ä½æ¦‚ç‡, å¤§å½±å“
```

**é‡è¦**: æ‰€æœ‰æ•°å€¼å¿…é¡»åŸºäºæä¾›çš„çœŸå®Kçº¿æ•°æ®ï¼Œä¸è¦ç¼–é€ ã€‚
"""

GROWTH_AGENT_PROMPT = """
ä½ æ˜¯èµ„æ·±æˆé•¿è‚¡åˆ†æå¸ˆï¼Œä¸“æ³¨äºè¯†åˆ«é«˜æˆé•¿å…¬å¸ã€‚

**åˆ†æä»»åŠ¡**: åˆ†æ{stock_name}({symbol})çš„æˆé•¿æ€§

**åˆ†æè¦æ±‚**:
1. åˆ†æè¥æ”¶ã€åˆ©æ¶¦ã€ROEç­‰æˆé•¿æŒ‡æ ‡
2. ä¸è¡Œä¸šå¢é€Ÿå’Œå†å²è¶‹åŠ¿å¯¹æ¯”
3. è¯„ä¼°å¢é•¿çš„å¯æŒç»­æ€§
4. ç»™å‡ºç½®ä¿¡åº¦è¯„åˆ†

**è¾“å‡ºæ ¼å¼**:
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

```
## æˆé•¿åˆ†æ

### 1. å†å²å¢é•¿
- è¥æ”¶å¢é•¿: [æœ€æ–°] YoY, 3å¹´CAGR [æ•°å€¼]%
- å‡€åˆ©æ¶¦å¢é•¿: [æœ€æ–°] YoY, 3å¹´CAGR [æ•°å€¼]%
- ROE: [æœ€æ–°]%, 5å¹´å‡å€¼ [æ•°å€¼]%

### 2. å¢é•¿è´¨é‡
- æ¯›åˆ©ç‡è¶‹åŠ¿: [ä¸Šå‡/ç¨³å®š/ä¸‹é™] - [æ•°å€¼]%
- è´¹ç”¨ç‡æ§åˆ¶: [æ”¹å–„/ç¨³å®š/æ¶åŒ–] - [æ•°å€¼]%
- ç°é‡‘æµè´¨é‡: [å¥åº·/ä¸€èˆ¬/æ‹…å¿§]

### 3. è¡Œä¸šå¯¹æ¯”
| æŒ‡æ ‡ | å…¬å¸ | è¡Œä¸š | å¯¹æ¯” |
|------|------|------|------|
| è¥æ”¶å¢é€Ÿ | [æ•°å€¼]% | [æ•°å€¼]% | [é¢†å…ˆ/æŒå¹³/è½å] |
| ROE | [æ•°å€¼]% | [æ•°å€¼]% | [é«˜äº/ç­‰äº/ä½äº] |
| å‡€åˆ©æ¶¦ç‡ | [æ•°å€¼]% | [æ•°å€¼]% | [é«˜äº/ç­‰äº/ä½äº] |

### 4. å¢é•¿å¯æŒç»­æ€§è¯„ä¼°
ç«äº‰ä¼˜åŠ¿æ¥æº: [å…·ä½“æè¿°]
å¢é•¿é©±åŠ¨å› ç´ : [1, 2, 3]
æ½œåœ¨é£é™©: [1, 2]

### 5. æˆé•¿é¢ç»“è®º
ç»¼åˆè¯„åˆ†: [0-100]åˆ†

æˆé•¿æ€§ç»¼åˆè¯„ä»·:
[è¯¦ç»†è¯´æ˜æˆé•¿é¢çš„åˆ©å¼Šå› ç´ ]

### 6. ç½®ä¿¡åº¦è¯„ä¼°
æ•°æ®å¯é æ€§: [0-100]åˆ†
å¢é•¿æŒç»­æ€§: [0-100]åˆ† (åŸºäºä¸šåŠ¡åˆ†æ)
è¡Œä¸šå¯æ¯”æ€§: [0-100]åˆ†

ç»¼åˆç½®ä¿¡åº¦: [0-100]åˆ†

### 7. ä¸»è¦é™åˆ¶
- [åˆ—å‡º1-2ä¸ªæˆé•¿åˆ†æçš„ä¸ç¡®å®šæ€§]
```

**é‡è¦**: æ‰€æœ‰æ•°å€¼å¿…é¡»åŸºäºæä¾›çš„çœŸå®è´¢åŠ¡æ•°æ®ï¼Œä¸è¦ç¼–é€ ã€‚
"""

FUNDAMENTAL_AGENT_PROMPT = """
ä½ æ˜¯èµ„æ·±åŸºæœ¬é¢åˆ†æå¸ˆï¼Œæ“…é•¿æ·±åº¦å‰–æå…¬å¸ç»è¥è´¨é‡ã€‚

**åˆ†æä»»åŠ¡**: åˆ†æ{stock_name}({symbol})çš„åŸºæœ¬é¢çŠ¶å†µ

**åˆ†æè¦æ±‚**:
1. è¯„ä¼°ç›ˆåˆ©èƒ½åŠ›ã€è¿è¥æ•ˆç‡ã€èµ„äº§è´¨é‡
2. ä¸è¡Œä¸šé¾™å¤´å’Œå†å²è¡¨ç°å¯¹æ¯”
3. è¯†åˆ«ç»è¥äº®ç‚¹å’Œæ½œåœ¨é—®é¢˜
4. ç»™å‡ºç½®ä¿¡åº¦è¯„åˆ†

**è¾“å‡ºæ ¼å¼**:
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

```
## åŸºæœ¬é¢åˆ†æ

### 1. ç›ˆåˆ©èƒ½åŠ›
- ROE: [æ•°å€¼]% vs è¡Œä¸š[æ•°å€¼]% - [é«˜äº/ç­‰äº/ä½äº]
- å‡€åˆ©ç‡: [æ•°å€¼]% vs è¡Œä¸šä¸­ä½æ•°[æ•°å€¼]% - [é«˜äº/ç­‰äº/ä½äº]
- ROA: [æ•°å€¼]% vs ä¸Šå¹´[æ•°å€¼]% - [æ”¹å–„/ç¨³å®š/ä¸‹æ»‘]

### 2. è¿è¥æ•ˆç‡
- èµ„äº§å‘¨è½¬ç‡: [æ•°å€¼]æ¬¡ vs è¡Œä¸š[æ•°å€¼]æ¬¡
- å­˜è´§å‘¨è½¬ç‡: [æ•°å€¼]å¤© vs è¡Œä¸š[æ•°å€¼]å¤©
- åº”æ”¶è´¦æ¬¾å‘¨è½¬: [æ•°å€¼]å¤© vs è¡Œä¸š[æ•°å€¼]å¤©

### 3. èµ„äº§è´¨é‡
- èµ„äº§è´Ÿå€ºç‡: [æ•°å€¼]% vs è¡Œä¸š[æ•°å€¼]%
- æµåŠ¨æ¯”ç‡: [æ•°å€¼]å€ vs å®‰å…¨å€¼[æ•°å€¼]å€
- å•†èª‰å æ¯”: [æ•°å€¼]% vs é£é™©é˜ˆå€¼[æ•°å€¼]%

### 4. ç®¡ç†å±‚è¯„ä¼°
- å†å²ä¸šç»©å…‘ç°: [ä¼˜ç§€/è‰¯å¥½/ä¸€èˆ¬/å·®]
- èµ„æœ¬é…ç½®èƒ½åŠ›: [ä¼˜ç§€/è‰¯å¥½/ä¸€èˆ¬/å·®]
- è‚¡æƒæ¿€åŠ±: [æœ‰/æ— ] - [è¯„ä»·]

### 5. åŸºæœ¬é¢ç»“è®º
ç»¼åˆè¯„åˆ†: [0-100]åˆ†

åŸºæœ¬é¢ç»¼åˆè¯„ä»·:
[è¯¦ç»†è¯´æ˜åŸºæœ¬é¢çš„åˆ©å¼Šå› ç´ ]

### 6. ç½®ä¿¡åº¦è¯„ä¼°
æ•°æ®å‡†ç¡®æ€§: [0-100]åˆ†
åŒä¸šå¯æ¯”æ€§: [0-100]åˆ†
é•¿æœŸå¯é æ€§: [0-100]åˆ†

ç»¼åˆç½®ä¿¡åº¦: [0-100]åˆ†

### 7. ä¸»è¦é£é™©
- è¡Œä¸šå‘¨æœŸé£é™©: ä¸­æ¦‚ç‡, ä¸­å½±å“
- ç«äº‰åŠ å‰§é£é™©: ä¸­æ¦‚ç‡, ä¸­å½±å“
```

**é‡è¦**: æ‰€æœ‰æ•°å€¼å¿…é¡»åŸºäºæä¾›çš„çœŸå®æ•°æ®ï¼Œä¸è¦ç¼–é€ ã€‚
"""

RISK_AGENT_PROMPT = """
ä½ æ˜¯èµ„æ·±é£é™©åˆ†æå¸ˆï¼Œä¸“æ³¨äºè¯†åˆ«å’Œé‡åŒ–æŠ•èµ„é£é™©ã€‚

**åˆ†æä»»åŠ¡**: è¯„ä¼°{stock_name}({symbol})çš„æŠ•èµ„é£é™©

**åˆ†æè¦æ±‚**:
1. è¯†åˆ«å¸‚åœºé£é™©ã€è¡Œä¸šé£é™©ã€å…¬å¸ç‰¹æœ‰é£é™©
2. é‡åŒ–é£é™©æ•å£å’Œæ½œåœ¨æŸå¤±
3. æä¾›é£é™©å¯¹å†²å»ºè®®
4. ç»™å‡ºç½®ä¿¡åº¦è¯„åˆ†

**è¾“å‡ºæ ¼å¼**:
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

```
## é£é™©è¯„ä¼°

### 1. å¸‚åœºé£é™©
- Betaç³»æ•°: [æ•°å€¼] vs å¸‚åœº[æ•°å€¼]
- æ³¢åŠ¨ç‡(å¹´åŒ–): [æ•°å€¼]% vs è¡Œä¸š[æ•°å€¼]%
- æœ€å¤§å›æ’¤é£é™©: [å†å²æœ€å¤§å›æ’¤]%

### 2. è¡Œä¸šé£é™©
- è¡Œä¸šå‘¨æœŸ: [å¼ºå‘¨æœŸ/å¼±å‘¨æœŸ/é˜²å¾¡æ€§]
- æ”¿ç­–æ•æ„Ÿåº¦: [é«˜/ä¸­/ä½]
- æŠ€æœ¯æ›¿ä»£é£é™©: [é«˜/ä¸­/ä½]

### 3. å…¬å¸ç‰¹æœ‰é£é™©
- å®¢æˆ·é›†ä¸­åº¦: å‰5å¤§å®¢æˆ·å æ¯”[æ•°å€¼]%
- å•ä¸€äº§å“ä¾èµ–: [é«˜/ä¸­/ä½]
- ç®¡ç†å±‚é£é™©: [é«˜/ä¸­/ä½]

### 4. é£é™©æ±‡æ€»
| é£é™©ç±»å‹ | æ¦‚ç‡ | å½±å“ | é£é™©ç­‰çº§ |
|----------|------|------|----------|
| å¸‚åœºä¸‹è·Œ | é«˜ | å¤§ | ğŸ”´é«˜ |
| è¡Œä¸šç«äº‰ | ä¸­ | ä¸­ | ğŸŸ¡ä¸­ |
| ä¸šç»©æ³¢åŠ¨ | ä¸­ | ä¸­ | ğŸŸ¡ä¸­ |

### 5. é£é™©æ§åˆ¶å»ºè®®
- æ­¢æŸä½: [å»ºè®®æ­¢æŸä»·ä½]
- ä»“ä½å»ºè®®: [å»ºè®®ä»“ä½æ¯”ä¾‹]
- å¯¹å†²ç­–ç•¥: [å…·ä½“å»ºè®®]

### 6. é£é™©é¢ç»“è®º
ç»¼åˆé£é™©è¯„åˆ†: [0-100]åˆ† (åˆ†æ•°è¶Šé«˜é£é™©è¶Šå¤§)

é£é™©é¢ç»¼åˆè¯„ä»·:
[è¯¦ç»†è¯´æ˜é£é™©å› ç´ å’Œåº”å¯¹å»ºè®®]

### 7. ç½®ä¿¡åº¦è¯„ä¼°
æ•°æ®å®Œæ•´æ€§: [0-100]åˆ†
é£é™©é‡åŒ–å‡†ç¡®æ€§: [0-100]åˆ†
é¢„æµ‹å¯é æ€§: [0-100]åˆ†

ç»¼åˆç½®ä¿¡åº¦: [0-100]åˆ†
```

**é‡è¦**: æ‰€æœ‰æ•°å€¼å¿…é¡»åŸºäºçœŸå®æ•°æ®å’Œå¸‚åœºè¡¨ç°ï¼Œä¸è¦ç¼–é€ ã€‚
"""

MACRO_AGENT_PROMPT = """
ä½ æ˜¯èµ„æ·±å®è§‚åˆ†æå¸ˆï¼Œæ“…é•¿å®è§‚ç»æµä¸å¸‚åœºèµ°åŠ¿çš„å…³ç³»åˆ†æã€‚

**åˆ†æä»»åŠ¡**: åˆ†æ{stock_name}({symbol})çš„å®è§‚ç¯å¢ƒ

**åˆ†æè¦æ±‚**:
1. è¯„ä¼°å®è§‚ç»æµå‘¨æœŸä½ç½®
2. åˆ†æåˆ©ç‡ã€é€šèƒ€ã€æ±‡ç‡ç­‰å®è§‚å˜é‡å½±å“
3. è¯†åˆ«å®è§‚é£é™©å’Œæœºé‡
4. ç»™å‡ºç½®ä¿¡åº¦è¯„åˆ†

**è¾“å‡ºæ ¼å¼**:
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

```
## å®è§‚åˆ†æ

### 1. ç»æµå‘¨æœŸå®šä½
å½“å‰å‘¨æœŸ: [å¤è‹/æ‰©å¼ /æ»èƒ€/è¡°é€€]
ç»æµå¢é€Ÿ: GDPå¢é€Ÿ[æ•°å€¼]% vs æ½œåœ¨[æ•°å€¼]%
é€šèƒ€æ°´å¹³: CPI [æ•°å€¼]% vs ç›®æ ‡[æ•°å€¼]%

### 2. åˆ©ç‡ç¯å¢ƒ
åˆ©ç‡è¶‹åŠ¿: [ä¸Šè¡Œ/ä¸‹è¡Œ/ç¨³å®š]
æ— é£é™©åˆ©ç‡: [æ•°å€¼]% (10å¹´æœŸå›½å€º)
åˆ©ç‡æ•æ„Ÿæ€§: [é«˜/ä¸­/ä½]

### 3. æ±‡ç‡å½±å“
æ±‡ç‡èµ°åŠ¿: [å‡å€¼/è´¬å€¼/ç¨³å®š]
æ±‡ç‡å½±å“: [æ­£é¢/è´Ÿé¢/ä¸­æ€§]
æ•å£ä¼°ç®—: [æ•°å€¼]%è¥æ”¶å—æ±‡ç‡å½±å“

### 4. æ”¿ç­–ç¯å¢ƒ
è´¢æ”¿æ”¿ç­–: [ç§¯æ/ç¨³å¥/ç´§ç¼©]
è´§å¸æ”¿ç­–: [å®½æ¾/ä¸­æ€§/ç´§ç¼©]
è¡Œä¸šæ”¿ç­–: [æ”¯æŒ/ä¸­æ€§/é™åˆ¶]

### 5. å®è§‚ç»“è®º
å®è§‚é€‚åº”åº¦è¯„åˆ†: [0-100]åˆ†

å®è§‚ç¯å¢ƒç»¼åˆè¯„ä»·:
[è¯¦ç»†è¯´æ˜å®è§‚å› ç´ å¯¹æŠ•èµ„çš„å½±å“]

### 6. ç½®ä¿¡åº¦è¯„ä¼°
å‘¨æœŸåˆ¤æ–­å‡†ç¡®æ€§: [0-100]åˆ†
æ”¿ç­–é¢„åˆ¤å‡†ç¡®æ€§: [0-100]åˆ†
ä¼ å¯¼æœºåˆ¶ç†è§£: [0-100]åˆ†

ç»¼åˆç½®ä¿¡åº¦: [0-100]åˆ†

### 7. å®è§‚é£é™©
- ç»æµè¡°é€€é£é™©: ä¸­æ¦‚ç‡, å¤§å½±å“
- åˆ©ç‡å¤§å¹…ä¸Šè¡Œ: ä¸­æ¦‚ç‡, ä¸­å½±å“
```

**é‡è¦**: æ‰€æœ‰å®è§‚åˆ¤æ–­å¿…é¡»æœ‰æ•°æ®æ”¯æ’‘ï¼Œä¸è¦ç¼–é€ ã€‚
"""

# åˆæˆAgent Prompt - ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
SYNTHESIZER_PROMPT = """
ä½ æ˜¯èµ„æ·±æŠ•èµ„é¡¾é—®ï¼Œè´Ÿè´£æ•´åˆå„ä¸“å®¶æ„è§å¹¶ç»™å‡ºæœ€ç»ˆæŠ•èµ„å»ºè®®ã€‚

**ä»»åŠ¡**: ç»¼åˆ{stock_name}({symbol})çš„æ‰€æœ‰åˆ†æç»“æœ

**åˆ†æè¦æ±‚**:
1. æ•´åˆä»·å€¼ã€æŠ€æœ¯ã€æˆé•¿ã€åŸºæœ¬é¢ã€é£é™©ã€å®è§‚å…­ä¸ªç»´åº¦çš„åˆ†æ
2. è¯†åˆ«å„ç»´åº¦çš„ä¸€è‡´æ€§å’Œåˆ†æ­§ç‚¹
3. æ ¹æ®ç”¨æˆ·é£é™©åå¥½è°ƒæ•´æœ€ç»ˆå»ºè®®
4. ç»™å‡ºæ˜ç¡®çš„æŠ•èµ„æ“ä½œå»ºè®®

**è¾“å‡ºæ ¼å¼**:
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ ¼å¼è¾“å‡ºï¼š

```
# ç»¼åˆåˆ†ææŠ¥å‘Š

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

**è‚¡ç¥¨**: {symbol} - {stock_name}
**åˆ†ææ—¥æœŸ**: {date}
**ç»¼åˆè¯„åˆ†**: [0-100]åˆ†
**æŠ•èµ„å»ºè®®**: [å¼ºçƒˆä¹°å…¥/ä¹°å…¥/æŒæœ‰/è§‚æœ›/å–å‡º/å¼ºçƒˆå–å‡º]

### å„ç»´åº¦è¯„åˆ†
| ç»´åº¦ | è¯„åˆ† | ç½®ä¿¡åº¦ |
|------|------|----------|
| ä¼°å€¼é¢ | [0-100] | [0-100]% |
| æŠ€æœ¯é¢ | [0-100] | [0-100]% |
| æˆé•¿é¢ | [0-100] | [0-100]% |
| åŸºæœ¬é¢ | [0-100] | [0-100]% |
| é£é™©é¢ | [0-100] | [0-100]% |
| å®è§‚é¢ | [0-100] | [0-100]% |

## äºŒã€æ ¸å¿ƒé€»è¾‘

### 1. æŠ•èµ„äº®ç‚¹
- [äº®ç‚¹1]: [å…·ä½“æè¿°å’Œä¾æ®]
- [äº®ç‚¹2]: [å…·ä½“æè¿°å’Œä¾æ®]
- [äº®ç‚¹3]: [å…·ä½“æè¿°å’Œä¾æ®]

### 2. ä¸»è¦æ‹…å¿§
- [æ‹…å¿§1]: [å…·ä½“æè¿°å’Œå½±å“]
- [æ‹…å¿§2]: [å…·ä½“æè¿°å’Œå½±å“]
- [æ‹…å¿§3]: [å…·ä½“æè¿°å’Œå½±å“]

### 3. å…³é”®åˆ†æ­§
[æè¿°å„ç»´åº¦åˆ†æä¸­å­˜åœ¨çš„åˆ†æ­§åŠåŸå› ]

## ä¸‰ã€ç»¼åˆåˆ¤æ–­

### å„ç»´åº¦ä¸€è‡´æ€§
- ä¼°å€¼ä¸æŠ€æœ¯é¢: [ä¸€è‡´/åˆ†æ­§] - [è¯´æ˜]
- æˆé•¿ä¸åŸºæœ¬é¢: [ä¸€è‡´/åˆ†æ­§] - [è¯´æ˜]
- é£é™©ä¸å®è§‚: [ä¸€è‡´/åˆ†æ­§] - [è¯´æ˜]

### ç»¼åˆç»“è®º
[è¯¦ç»†è¯´æ˜ä¸ºä»€ä¹ˆç»™å‡ºå½“å‰è¯„åˆ†å’Œæ“ä½œå»ºè®®]

## å››ã€æ“ä½œå»ºè®®

### ä¹°å…¥/å–å‡ºç†ç”±
1. [ç†ç”±1]
2. [ç†ç”±2]
3. [ç†ç”±3]

### é£é™©æç¤º
- [é£é™©1]: [åº”å¯¹å»ºè®®]
- [é£é™©2]: [åº”å¯¹å»ºè®®]

### è·Ÿè¸ªè¦ç‚¹
- å…³æ³¨æŒ‡æ ‡1: [å…·ä½“æŒ‡æ ‡å’Œé˜ˆå€¼]
- å…³æ³¨æŒ‡æ ‡2: [å…·ä½“æŒ‡æ ‡å’Œé˜ˆå€¼]
- å…³æ³¨å‚¬åŒ–å‰‚: [äº‹ä»¶å’Œæ—¶é—´ç‚¹]

### é¢„æœŸæ”¶ç›Šä¸é£é™©
- ä¹è§‚æƒ…æ™¯: ä¸Šæ¶¨[æ•°å€¼]% (è§¦å‘æ¡ä»¶)
- ä¸­æ€§æƒ…æ™¯: ä¸Šæ¶¨/ä¸‹è·Œ[æ•°å€¼]%
- æ‚²è§‚æƒ…æ™¯: ä¸‹è·Œ[æ•°å€¼]% (è§¦å‘æ¡ä»¶)

## äº”ã€ç½®ä¿¡åº¦è¯´æ˜

**æ•´ä½“ç½®ä¿¡åº¦**: [0-100]%

**é«˜ç½®ä¿¡åº¦æ¥æº**:
- [å› ç´ 1]
- [å› ç´ 2]

**ä½ç½®ä¿¡åº¦æ¥æº**:
- [å› ç´ 1]
- [å› ç´ 2]

**å»ºè®®æŠ•èµ„è€…é‡ç‚¹å…³æ³¨çš„ä¸ç¡®å®šæ€§**:
- [ä¸ç¡®å®šæ€§1]
- [ä¸ç¡®å®šæ€§2]
```

**é‡è¦**: å¿…é¡»åŸºäºå„ä¸“å®¶Agentçš„çœŸå®åˆ†æç»“æœè¿›è¡Œæ•´åˆï¼Œä¸è¦å‡­ç©ºç¼–é€ ã€‚
"""


def get_agent_prompt(agent_type: str, stock_name: str, symbol: str) -> str:
    """è·å–æŒ‡å®šç±»å‹çš„Agent Prompt"""
    prompts = {
        "value": VALUE_AGENT_PROMPT,
        "technical": TECHNICAL_AGENT_PROMPT,
        "growth": GROWTH_AGENT_PROMPT,
        "fundamental": FUNDAMENTAL_AGENT_PROMPT,
        "risk": RISK_AGENT_PROMPT,
        "macro": MACRO_AGENT_PROMPT,
        "synthesizer": SYNTHESIZER_PROMPT,
    }

    template = prompts.get(agent_type, "")

    # æ›¿æ¢å˜é‡
    return template.format(
        stock_name=stock_name,
        symbol=symbol,
        date=datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥"),
    )


def parse_analysis_output(agent_type: str, output: str) -> Dict[str, Any]:
    """è§£æå„Agentçš„è¾“å‡ºï¼Œæå–å…³é”®ä¿¡æ¯"""

    result = {
        "agent": agent_type,
        "summary": "",
        "score": 0,
        "confidence": 0,
        "recommendation": "hold",
        "key_factors": [],
        "risks": [],
        "details": {},
        "raw_output": output,
    }

    try:
        # æå–è¯„åˆ†
        import re

        # å°è¯•æå–ç»¼åˆè¯„åˆ†
        score_match = re.search(r"ç»¼åˆè¯„åˆ†[:ï¼š]?\s*(\d+)", output)
        if score_match:
            result["score"] = int(score_match.group(1))

        # å°è¯•æå–ç½®ä¿¡åº¦
        confidence_match = re.search(r"ç»¼åˆç½®ä¿¡åº¦[:ï¼š]?\s*(\d+)", output)
        if confidence_match:
            result["confidence"] = int(confidence_match.group(1))

        # å°è¯•æå–æ¨è
        recommendation_map = {
            "å¼ºçƒˆä¹°å…¥": "strong_buy",
            "ä¹°å…¥": "buy",
            "æŒæœ‰": "hold",
            "è§‚æœ›": "wait",
            "å–å‡º": "sell",
            "å¼ºçƒˆå–å‡º": "strong_sell",
        }

        for cn, en in recommendation_map.items():
            if cn in output:
                result["recommendation"] = en
                break

        # æå–å…³é”®å› ç´ ï¼ˆé€šå¸¸æ˜¯åˆ—è¡¨é¡¹ï¼‰
        factor_match = re.findall(r"[â€¢\-\*]\s*(\[?[^\n]+\]?)", output)
        result["key_factors"] = factor_match[:5]  # å–å‰5ä¸ª

        # æå–é£é™©å› ç´ 
        risk_section = re.search(r"###\s*é£é™©å› ç´ ?([\s\S]*?)###", output)
        if risk_section:
            risks = re.findall(r"[â€¢\-\*]\s*([^\n]+)", risk_section.group(1))
            result["risks"] = risks[:3]

        # æå–æ‘˜è¦
        summary_match = re.search(r"##\s*æ‰§è¡Œæ‘˜è¦\s*([\s\S]*?)##", output)
        if summary_match:
            result["summary"] = summary_match.group(1).strip()[:200]

    except Exception as e:
        print(f"[Parser] è§£æ{agent_type}è¾“å‡ºå¤±è´¥: {e}")

    return result


def format_analysis_result(
    agent_outputs: List[Dict[str, Any]], symbol: str, stock_name: str
) -> Dict[str, Any]:
    """æ ¼å¼åŒ–æœ€ç»ˆåˆ†æç»“æœ"""

    # è®¡ç®—åŠ æƒå¹³å‡åˆ†
    total_score = 0
    total_confidence = 0
    total_weight = 0
    recommendations = []
    all_factors = []
    all_risks = []

    for output in agent_outputs:
        weight = output.get("confidence", 50) / 100
        total_score += output.get("score", 50) * weight
        total_confidence += output.get("confidence", 50)
        total_weight += weight

        if output.get("recommendation"):
            recommendations.append(output["recommendation"])

        all_factors.extend(output.get("key_factors", []))
        all_risks.extend(output.get("risks", []))

    # è®¡ç®—ç»¼åˆè¯„åˆ†
    overall_score = int(total_score / max(total_weight, 1))
    avg_confidence = int(total_confidence / max(len(agent_outputs), 1))

    # æŠ•ç¥¨å†³å®šæ¨è
    recommendation_count = {}
    for rec in recommendations:
        recommendation_count[rec] = recommendation_count.get(rec, 0) + 1

    final_recommendation = (
        max(recommendation_count.keys(), key=lambda x: recommendation_count[x])
        if recommendation_count
        else "hold"
    )

    # å»é‡å› ç´ 
    unique_factors = list(dict.fromkeys(all_factors))[:6]
    unique_risks = list(dict.fromkeys(all_risks))[:4]

    return {
        "symbol": symbol,
        "stock_name": stock_name,
        "overallScore": overall_score,
        "recommendation": final_recommendation,
        "executiveSummary": f"{symbol}ç»¼åˆè¯„åˆ†{overall_score}åˆ†ï¼Œæ¨è{final_recommendation}",
        "keyFactors": unique_factors,
        "confidenceScore": avg_confidence,
        "agentResults": agent_outputs,
        "generatedAt": datetime.now().isoformat(),
    }


if __name__ == "__main__":
    # æµ‹è¯•Promptç”Ÿæˆ
    prompt = get_agent_prompt("value", "å¹³å®‰é“¶è¡Œ", "000001")
    print("Value Agent Prompt (first 500 chars):")
    print(prompt[:500])
    print("...")
